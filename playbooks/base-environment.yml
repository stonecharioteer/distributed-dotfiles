---
# Base development environment setup for ALL systems
# Includes shell environment, development tools, and core utilities
- name: Base Development Environment Setup
  hosts: all
  become: yes
  gather_facts: true
  vars:
    dev_user: "{{ ansible_user | default('stonecharioteer') }}"
    dev_home: "/home/{{ dev_user }}"
    
  pre_tasks:
    - name: Update package cache (Debian/Ubuntu)
      apt:
        update_cache: yes
        cache_valid_time: 86400
      when: ansible_os_family == "Debian"
      
    - name: Check which packages are missing
      shell: dpkg -l {{ item }} 2>/dev/null | grep -q '^ii' || echo "{{ item }}"
      register: missing_packages_check
      loop:
        - curl
        - wget
        - git
        - unzip
        - tar
        - gzip
        - software-properties-common
        - apt-transport-https
        - ca-certificates
        - gnupg
        - lsb-release
        - htop
        - tree
        - rsync
      changed_when: false
      failed_when: false
      when: ansible_os_family == "Debian"

    - name: Create list of packages to install
      set_fact:
        packages_to_install: "{{ missing_packages_check.results | selectattr('stdout', 'defined') | selectattr('stdout', '!=', '') | map(attribute='stdout') | list }}"
      when: ansible_os_family == "Debian"

    - name: Install missing system packages
      apt:
        name: "{{ packages_to_install }}"
        state: present
        install_recommends: no
        force_apt_get: yes
      when: 
        - ansible_os_family == "Debian"
        - packages_to_install is defined
        - packages_to_install | length > 0

  roles:
    # Failsafe checks for all components
    - role: failsafe-checks
      tags: [always]

    # Shell Environment
    - role: fish-shell
      tags: [shell, fish]
    - role: fish-repository-setup
      tags: [shell, fish, dotfiles]
    - role: scripts-repository-setup
      tags: [shell, scripts]
    - role: mise-tools
      tags: [shell, mise, languages]
    - role: rust-toolchain
      tags: [shell, rust, languages]
    - role: fish-config
      tags: [shell, fish, config]

    # Development Environment
    - role: system-deps
      tags: [dev, deps]
    - role: git-config
      tags: [dev, git, config]
    - role: cli-tools
      tags: [dev, cli]
    - role: dev-folders
      tags: [dev, folders]
    - role: tmux
      tags: [dev, tmux]
    - role: neovim-latest
      tags: [dev, neovim, editor]
    - role: tree-sitter-cli
      tags: [dev, neovim]
    - role: nvim-config
      tags: [dev, neovim, editor, config]
    - role: hugo
      tags: [dev, hugo, blog]
    - role: docker
      tags: [dev, docker, containers]

  post_tasks:
    - name: Display base environment setup completion
      debug:
        msg: |
          ğŸš€ Base Development Environment Setup Complete!
          
          ğŸš Shell Environment:
          âœ“ Fish shell with syntax highlighting and modern features
          âœ“ Fish dotfiles cloned from: git@github.com:stonecharioteer/dotfiles-fish.git
          âœ“ Personal scripts repository cloned from: git@github.com:stonecharioteer/scripts.git
          âœ“ mise runtime manager (Node.js, Python, Go, Rust)
          âœ“ Enhanced Rust toolchain with cargo-binstall
          âœ“ Fish configuration with abbreviations and integrations
          
          ğŸ› ï¸ Development Environment:
          âœ“ System dependencies and development headers
          âœ“ Modern CLI tools (ripgrep, fd, fzf, starship, etc.)
          âœ“ Database tools (PostgreSQL client, pgcli)
          âœ“ Development folder structure
          âœ“ tmux compiled from latest source
          âœ“ Neovim {{ neovim_version | default('latest') }} with vim symlink
          âœ“ tree-sitter CLI for syntax highlighting
          âœ“ Custom Neovim configuration from git@github.com:stonecharioteer/nvim-config.git
          âœ“ Hugo Extended {{ hugo_version | default('0.146.7') }} static site generator
          âœ“ Docker Engine with Compose plugin
          
          ğŸ“‹ Next Steps:
          1. Log out and log back in for shell/group changes
          2. Test development environment:
             - tmux new-session -d -s test
             - docker run hello-world
             - nvim --version
             - mise list (verify language runtimes)
             - psql --version && pgcli --version (database tools)
             - hugo version (static site generator)
          
          ğŸ¯ Your base development environment is ready!
          - Modern shell: Fish with mise for language management
          - Development tools: tmux, Neovim/AstroNvim, Docker
          - All CLI tools integrated and configured for productivity
          
          ğŸ’¡ For GUI systems, also run:
          - ansible-playbook playbooks/gui-environment.yml