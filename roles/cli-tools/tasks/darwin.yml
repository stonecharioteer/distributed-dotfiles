---
# macOS-specific CLI tools installation
- name: Install CLI development tools via Homebrew
  shell: |
    export HOMEBREW_NO_AUTO_UPDATE=1
    export PATH="/opt/homebrew/bin:$PATH"

    packages=(
      ripgrep fd zoxide starship fzf direnv tree httpie
      pgcli htop btop gum glow jq yq cowsay fortune lolcat neofetch lsd
      watchexec bandwhich
    )

    for package in "${packages[@]}"; do
      if ! brew list "$package" &>/dev/null; then
        echo "Installing $package..."
        brew install "$package" || echo "Warning: Failed to install $package"
      else
        echo "$package is already installed"
      fi
    done
  args:
    executable: /bin/bash
  become: no
  register: brew_install_result
  changed_when: "'Installing' in brew_install_result.stdout"

- name: Display Homebrew installation output
  debug:
    msg: "{{ brew_install_result.stdout_lines }}"
  when: brew_install_result.stdout_lines is defined

- name: Install cargo-based tools on macOS
  shell: |
    source {{ ansible_env.HOME }}/.cargo/env
    if ! command -v "{{ item.value.binary }}" &>/dev/null; then
      echo "Installing {{ item.value.package }}..."
      cargo binstall -y "{{ item.value.package }}"
    else
      echo "{{ item.value.binary }} is already installed"
    fi
    {{ item.value.check_cmd }}
  args:
    executable: /bin/bash
  loop: "{{ cargo_tools | dict2items | selectattr('key', 'in', macos_cargo_tools) | list }}"
  loop_control:
    label: "{{ item.key }}"
  become: no
  environment:
    HOME: "{{ ansible_env.HOME }}"
  register: macos_cargo_results
  changed_when: "'Installing' in item.stdout | default('')"
  ignore_errors: yes

- name: Verify CLI tools installation
  command: "{{ item }} --version"
  loop:
    - rg
    - fd
    - fzf
    - zoxide
    - direnv
    - http
    - starship
    - gum
    - glow
    - watchexec
    - bandwhich
    - lsd
    - sg
  register: cli_tool_versions
  changed_when: false
  ignore_errors: yes
  become: no

- name: Display CLI tools installation summary
  debug:
    msg: |
      CLI Development Tools installed on macOS

      Verified tools:
      {% for result in cli_tool_versions.results %}
      {% if result.rc == 0 %}
      ✓ {{ result.item }}
      {% else %}
      ⚠ {{ result.item }} not available
      {% endif %}
      {% endfor %}
