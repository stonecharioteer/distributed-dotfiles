---
# Include macOS-specific tasks
- name: Include macOS-specific tasks
  include_tasks: darwin.yml
  when: ansible_os_family == "Darwin"

- name: Install CLI development tools via package manager
  package:
    name: "{{ cli_packages }}"
    state: present
  when: ansible_os_family == "Debian"

- name: Create fd symlink (Ubuntu packages fd-find as fdfind)
  file:
    src: /usr/bin/fdfind
    dest: /usr/local/bin/fd
    state: link
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Check if Starship is already installed
  command: "{{ external_tools.starship.check_cmd }}"
  register: starship_check
  ignore_errors: yes
  changed_when: false

- name: Install Starship prompt
  block:
    - name: Download Starship installer
      get_url:
        url: "{{ external_tools.starship.url }}"
        dest: /tmp/install-starship.sh
        mode: '0755'

    - name: Install Starship
      shell: /tmp/install-starship.sh --yes
      environment:
        BIN_DIR: /usr/local/bin

    - name: Clean up Starship installer
      file:
        path: /tmp/install-starship.sh
        state: absent

    - name: Verify Starship installation
      command: "{{ external_tools.starship.check_cmd }}"
      register: starship_version
      changed_when: false

    - name: Display Starship installation success
      debug:
        msg: "✓ Starship installed: {{ starship_version.stdout }}"

  when:
    - ansible_os_family != "Darwin"
    - starship_check.rc != 0
  rescue:
    - name: Display Starship installation failure
      debug:
        msg: "⚠ Starship installation failed - continuing with other tools"

- name: Check if Gum is already installed
  command: "{{ external_tools.gum.check_cmd }}"
  register: gum_check
  ignore_errors: yes
  changed_when: false

- name: Install Gum terminal UI tools
  block:
    - name: Add Charm repository GPG key
      apt_key:
        url: "{{ external_tools.gum.repo_key }}"
        state: present

    - name: Add Charm repository
      apt_repository:
        repo: "{{ external_tools.gum.repo_line }}"
        state: present

    - name: Install Gum
      package:
        name: "{{ external_tools.gum.package }}"
        state: present
        update_cache: yes

    - name: Verify Gum installation
      command: "{{ external_tools.gum.check_cmd }}"
      register: gum_version
      changed_when: false

    - name: Display Gum installation success
      debug:
        msg: "✓ Gum installed: {{ gum_version.stdout }}"

  when:
    - ansible_os_family == "Debian"
    - gum_check.rc != 0
  rescue:
    - name: Display Gum installation failure
      debug:
        msg: "⚠ Gum installation failed - continuing with other tools"

- name: Check if Glow is already installed
  command: "{{ external_tools.glow.check_cmd }}"
  register: glow_check
  ignore_errors: yes
  changed_when: false

- name: Install Glow markdown renderer
  block:
    - name: Add Charm repository GPG key (if not already added)
      apt_key:
        url: "{{ external_tools.glow.repo_key }}"
        state: present

    - name: Add Charm repository (if not already added)
      apt_repository:
        repo: "{{ external_tools.glow.repo_line }}"
        state: present

    - name: Install Glow
      package:
        name: "{{ external_tools.glow.package }}"
        state: present
        update_cache: yes

    - name: Verify Glow installation
      command: "{{ external_tools.glow.check_cmd }}"
      register: glow_version
      changed_when: false

    - name: Display Glow installation success
      debug:
        msg: "✓ Glow installed: {{ glow_version.stdout }}"

  when:
    - ansible_os_family == "Debian"
    - glow_check.rc != 0
  rescue:
    - name: Display Glow installation failure
      debug:
        msg: "⚠ Glow installation failed - continuing with other tools"

- name: Check if Rust/cargo is available for cargo tools
  shell: |
    source {{ dev_home }}/.cargo/env
    command -v cargo
  args:
    executable: /bin/bash
  register: cargo_check
  become_user: "{{ dev_user }}"
  ignore_errors: yes
  changed_when: false

- name: Install cargo-based tools
  block:
    - name: Check if cargo-binstall is available
      shell: |
        source {{ dev_home }}/.cargo/env
        command -v cargo-binstall
      args:
        executable: /bin/bash
      register: cargo_binstall_check
      become_user: "{{ dev_user }}"
      ignore_errors: yes
      changed_when: false

    - name: Install cargo-binstall if not available
      shell: |
        source {{ dev_home }}/.cargo/env
        cargo install cargo-binstall
      args:
        executable: /bin/bash
      become_user: "{{ dev_user }}"
      environment:
        HOME: "{{ dev_home }}"
      when: cargo_binstall_check.rc != 0

    - name: Install cargo tools via binstall
      shell: |
        source {{ dev_home }}/.cargo/env
        if ! command -v "{{ item.value.binary }}" &>/dev/null; then
          echo "Installing {{ item.value.package }}..."
          cargo binstall -y "{{ item.value.package }}"
        else
          echo "{{ item.value.binary }} is already installed"
        fi
        {{ item.value.check_cmd }}
      args:
        executable: /bin/bash
      loop: "{{ cargo_tools | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      become_user: "{{ dev_user }}"
      environment:
        HOME: "{{ dev_home }}"
      register: cargo_tool_results
      changed_when: "'Installing' in item.stdout | default('')"

    - name: Set capabilities for bandwhich (allows running without sudo)
      command: setcap cap_sys_ptrace,cap_dac_read_search,cap_net_raw,cap_net_admin+ep {{ dev_home }}/.cargo/bin/bandwhich
      ignore_errors: yes
      when: "'bandwhich' in (cargo_tools | list)"

  when:
    - ansible_os_family != "Darwin"
    - cargo_check.rc == 0
  rescue:
    - name: Display cargo tools installation failure
      debug:
        msg: "⚠ Cargo tools installation failed - ensure Rust is installed (system installation)"

- name: Verify CLI tools installation
  command: "{{ item }} --version"
  loop:
    - rg              # ripgrep
    - fd              # fd-find  
    - fzf
    - zoxide
    - direnv
    - http            # httpie
  register: cli_tool_versions
  changed_when: false
  ignore_errors: yes

- name: Display CLI tools installation summary
  debug:
    msg: |
      CLI Development Tools Installation Summary:

      {% if ansible_os_family == "Darwin" %}
      ✓ All CLI tools installed via Homebrew on macOS
      {% else %}
      Package-based tools: {{ cli_packages | join(', ') }}

      Cargo tools:
      {% if cargo_tool_results is defined %}
      {% for result in cargo_tool_results.results %}
      {% if 'Installing' in result.stdout | default('') %}
      ✓ {{ result.item.key }} installed via cargo binstall
      {% else %}
      ✓ {{ result.item.key }} already installed
      {% endif %}
      {% endfor %}
      {% elif cargo_check is defined and cargo_check.rc != 0 %}
      ⚠ Cargo not available - cargo tools skipped
      {% endif %}
      {% endif %}

      Verified tools:
      {% for result in cli_tool_versions.results %}
      {% if result.rc == 0 %}
      ✓ {{ result.item }}
      {% else %}
      ⚠ {{ result.item }} not available
      {% endif %}
      {% endfor %}