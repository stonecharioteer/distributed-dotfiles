---
# macOS-specific Rust toolchain installation
- name: Check if rustup is already installed
  stat:
    path: "{{ dev_home }}/.cargo/bin/rustup"
  register: rustup_exists
  become: no

- name: Download rustup installer
  get_url:
    url: https://sh.rustup.rs
    dest: /tmp/rustup-init.sh
    mode: '0755'
  when: not rustup_exists.stat.exists
  become: no

- name: Install rustup (Rust toolchain installer)
  shell: /tmp/rustup-init.sh -y --default-toolchain stable
  environment:
    CARGO_HOME: "{{ dev_home }}/.cargo"
    RUSTUP_HOME: "{{ dev_home }}/.rustup"
  when: not rustup_exists.stat.exists
  become: no

- name: Clean up rustup installer
  file:
    path: /tmp/rustup-init.sh
    state: absent
  when: not rustup_exists.stat.exists
  become: no

- name: Check if cargo-binstall is already installed
  stat:
    path: "{{ dev_home }}/.cargo/bin/cargo-binstall"
  register: cargo_binstall_exists
  become: no

- name: Install cargo-binstall
  shell: |
    source "{{ dev_home }}/.cargo/env"
    cargo install cargo-binstall
  args:
    executable: /bin/bash
  environment:
    CARGO_HOME: "{{ dev_home }}/.cargo"
    RUSTUP_HOME: "{{ dev_home }}/.rustup"
  when: not cargo_binstall_exists.stat.exists
  become: no

- name: Install essential Rust CLI tools via cargo-binstall
  shell: |
    source "{{ dev_home }}/.cargo/env"
    cargo binstall -y {{ item }}
  args:
    executable: /bin/bash
  environment:
    CARGO_HOME: "{{ dev_home }}/.cargo"
    RUSTUP_HOME: "{{ dev_home }}/.rustup"
  with_items:
    - bat          # Better cat with syntax highlighting
    - tokei        # Code statistics
    - du-dust      # Better du
    - bottom       # Better top
    - xh           # Better httpie in Rust
    - eza          # Better ls (replaces exa)
    - lsd          # LSDeluxe - another modern ls
    - procs        # Better ps
  become: no
  ignore_errors: yes

- name: Install additional modern CLI tools via cargo-binstall
  shell: |
    source "{{ dev_home }}/.cargo/env"
    cargo binstall -y {{ item }}
  args:
    executable: /bin/bash
  environment:
    CARGO_HOME: "{{ dev_home }}/.cargo"
    RUSTUP_HOME: "{{ dev_home }}/.rustup"
  with_items:
    - sd           # Better sed
    - tealdeer     # tldr client
    - grex         # Regex generator
    - gitui        # Terminal UI for git
    - atuin        # Shell history sync and search
  become: no
  ignore_errors: yes

- name: Add cargo bin to fish config
  lineinfile:
    path: "{{ dev_home }}/.config/fish/config.fish"
    line: 'fish_add_path {{ dev_home }}/.cargo/bin'
    create: yes
    owner: "{{ dev_user }}"
  become: no

- name: Display Rust toolchain installation summary
  debug:
    msg: |
      âœ“ Rust toolchain installed on macOS

      Installed via rustup:
      - rustc (Rust compiler)
      - cargo (Package manager)
      - cargo-binstall (Fast binary installer)

      Essential CLI tools:
      - bat, tokei, du-dust, bottom, xh, eza, lsd, procs
      - sd, tealdeer, grex, gitui, atuin

      Note: Some tools like ripgrep, fd, zoxide are installed via Homebrew in cli-tools role
