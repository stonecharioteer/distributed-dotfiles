---
# macOS-specific Docker installation
- name: Check if Docker Desktop is installed
  stat:
    path: /Applications/Docker.app
  register: docker_desktop_check
  become: no

- name: Check if Docker CLI is available
  command: docker --version
  register: docker_version_check
  ignore_errors: yes
  changed_when: false
  become: no

- name: Ensure directories required by Docker cask exist and are writable
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: admin
  become: yes
  loop:
    - /usr/local/bin
    - /usr/local/cli-plugins
  when: not docker_desktop_check.stat.exists

- name: Install Docker Desktop via Homebrew cask
  shell: |
    export HOMEBREW_NO_AUTO_UPDATE=1
    export PATH="/opt/homebrew/bin:$PATH"

    if ! brew list --cask docker &>/dev/null; then
      echo "Installing Docker Desktop..."
      brew install --cask docker
    else
      echo "Docker Desktop is already installed"
    fi
  args:
    executable: /bin/bash
  become: no
  register: docker_install_result
  changed_when: "'Installing' in docker_install_result.stdout"
  when: not docker_desktop_check.stat.exists

- name: Display Docker installation output
  debug:
    msg: "{{ docker_install_result.stdout_lines }}"
  when: docker_install_result.stdout_lines is defined and not docker_desktop_check.stat.exists

- name: Verify Docker installation
  stat:
    path: /Applications/Docker.app
  register: docker_verify
  become: no

- name: Display Docker installation instructions for macOS
  debug:
    msg: |
      Docker on macOS:

      {% if docker_verify.stat.exists %}
      âœ“ Docker Desktop is installed at /Applications/Docker.app
      {% if docker_version_check.rc == 0 %}
      âœ“ Docker CLI available: {{ docker_version_check.stdout }}
      {% else %}
      âš  Docker Desktop installed but not running - launch it from Applications
      {% endif %}
      {% else %}
      âš  Docker Desktop installation may require manual steps
      {% endif %}

      ðŸ“‹ Next Steps:
      1. Launch Docker Desktop from Applications or Spotlight
      2. Accept the Docker Desktop license agreement
      3. Docker will configure itself and start the Docker daemon
      4. Once Docker is running, verify with: docker run hello-world

      Note: Docker on macOS requires Docker Desktop to run containers.
      Docker Desktop will start automatically at login once configured.
